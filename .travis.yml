os: linux
services: docker
dist: jammy
language: go
env:
  global:
    - DEFAULT_BRANCH: master
    - GOPROXY: https://proxy.golang.org,https://goproxy.io,direct

jobs:
  include:
    - stage: check
      if: tag IS NOT present
      sudo: false
      go: 1.25.0
      before_install:
        - go install github.com/mattn/goveralls@v0.0.12
      install:
        - export PATH=$PATH:$GOPATH/bin
      script:
        - echo "Starting build"
        - make goinstall
        - echo "Running tests with coverage"
        - make check 2>&1 | tee /tmp/check.log
        - echo "Test completion"
        - echo "Coverage files created"
        - ls -la covprof-* 2>/dev/null || echo "No coverage files found"
        - echo "Coverage summary"
        - for f in covprof-*; do if [ -f "$f" ]; then echo "File $f"; go tool cover -func="$f" | tail -1; fi; done
      after_failure:
        - echo "Build failed, showing logs"
        - grep -C 200 FAIL /tmp/check.log || echo "No FAIL found in logs"
        - tail -300 /tmp/check.log
      after_success:
        - echo "Build succeeded, uploading coverage"
        - echo "Final coverage files"
        - ls -la covprof-*
        - echo "Uploading to Coveralls"
        - $GOPATH/bin/goveralls -coverprofile=covprof-hostagent -service=travis-pro -v
        - echo "Coveralls upload completed"